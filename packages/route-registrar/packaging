#!/usr/bin/env bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables
set +x

mkdir -p ${BOSH_INSTALL_TARGET}/src
cp -a . ${BOSH_INSTALL_TARGET}/src
export GOPATH=$BOSH_INSTALL_TARGET

#compile
export GOROOT=$(readlink -nf /var/vcap/packages/golang)
export PATH=/var/vcap/packages/git/bin:$PATH
export PATH=$GOROOT/bin:$PATH

go install github.com/cloudfoundry-incubator/route-registrar

cp $GOPATH/bin/route-registrar $BOSH_INSTALL_TARGET/route-registrar
cp ${BOSH_INSTALL_TARGET}/src/github.com/cloudfoundry-incubator/route-registrar/healthchecker/check_node_validity.sh $BOSH_INSTALL_TARGET/check_node_validity.sh
chmod +rx $BOSH_INSTALL_TARGET/check_node_validity.sh
